âš ï¸ **THESE RULES ONLY APPLY TO FILES IN /halos-marine-containers/** âš ï¸

# HaLOS Marine Containers - Development Guide

## ğŸ¯ For Agentic Coding: Use the HaLOS Workspace

This repository should be used as part of the halos-distro workspace for AI-assisted development:

```bash
# Clone workspace and all repos
git clone https://github.com/hatlabs/halos-distro.git
cd halos-distro
./run repos:clone
```

See `halos-distro/docs/` for development workflows and guidance.

## About This Project

Marine container store definition and curated marine application definitions.

**Local Instructions**: For environment-specific instructions and configurations, see @CLAUDE.local.md (not committed to version control).

## Git Workflow Policy

**Branch Workflow:** Never push to main directly - always use feature branches and PRs.

**Link issues and PRs:** Always link related GitHub issues in PR descriptions with `Closes #<issue-number>`.

## Version Management

This repository has two separate versioning systems:

### 1. VERSION File (Meta/Bundle Version)

The `VERSION` file is a **meta-version for git tags only**. It does NOT control Debian package versions.

- Used by CI to create git tags: `v{VERSION}+{N}_pre` and `v{VERSION}+{N}`
- Controls when new releases are triggered
- Bump this when you want a new release bundle

### 2. Store Package Version (store/debian/changelog)

The `marine-container-store` package uses the **committed `store/debian/changelog`** as its canonical version source (standard Debian practice).

- Edit `store/debian/changelog` to set the store package version
- The store package is only rebuilt when this file changes
- CI does NOT auto-generate this file

### Releasing a New Store Package Version

```bash
# 1. Update store/debian/changelog with new version and changes
dch -i  # or edit manually

# 2. Commit and push
git add store/debian/changelog
git commit -m "chore(store): bump to 0.2.0-1"
git push origin main
```

### App Package Versions

Individual apps in `apps/` have their own versions in `metadata.yaml`. These are independent of both VERSION and store/debian/changelog.

### Git Tags (auto-generated by CI)

- Pre-release: `v{VERSION}+{N}_pre` (unstable channel)
- Stable: `v{VERSION}+{N}` (stable channel)
- N = auto-calculated from existing git tags

### Version Scripts

- **`.github/scripts/calculate-revision.sh`**: Query git tags to find next N
- **`.github/scripts/generate-changelog.sh`**: No-op (preserves committed changelog)

**CI Enforcement**: PRs that change app files in `apps/<app>/` must include a bump to the `version` field in `apps/<app>/metadata.yaml`, or CI will fail. Changes outside `apps/` that affect the package also require a VERSION file bump.

## What This Repository Contains

**Two things in one repository**:
1. **Marine Container Store** (`store/`) - Store definition package
2. **Marine Apps** (`apps/`) - Curated marine application definitions

**Rationale**: Store and apps are tightly coupled. The store defines which apps belong in the marine category, and those apps live right here. Single source of truth, unified CI/CD.

## Repository Structure

```
halos-marine-containers/
â”œâ”€â”€ store/
â”‚   â”œâ”€â”€ marine.yaml          # Store configuration
â”‚   â”œâ”€â”€ icon.svg             # Branding (256x256)
â”‚   â”œâ”€â”€ banner.png           # Branding (1200x300)
â”‚   â””â”€â”€ debian/              # Debian packaging for store package
â”‚       â”œâ”€â”€ control
â”‚       â”œâ”€â”€ rules
â”‚       â”œâ”€â”€ install
â”‚       â””â”€â”€ ...
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ signalk-server/
â”‚   â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”‚   â”œâ”€â”€ config.yml
â”‚   â”‚   â”œâ”€â”€ metadata.json
â”‚   â”‚   â””â”€â”€ icon.png
â”‚   â”œâ”€â”€ opencpn/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ tools/
â”‚   â””â”€â”€ build-all.sh         # Build all packages
â”œâ”€â”€ .github/workflows/
â”‚   â””â”€â”€ build.yml            # CI/CD
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ DESIGN.md            # Detailed design docs
â””â”€â”€ README.md
```

## Adding a New Marine App

See [docs/DESIGN.md](docs/DESIGN.md) for complete instructions.

**Quick overview**:
1. Create `apps/<app-name>/` directory
2. Add `docker-compose.yml`, `config.yml`, `metadata.json`, `icon.png`
3. Test locally with `generate-container-packages`
4. Create PR - CI will build and validate

## Building

**Requirements**: `container-packaging-tools` installed

```bash
# Build all packages (store + apps)
./tools/build-all.sh

# Output: build/*.deb
```

**CI/CD**: GitHub Actions builds on push and creates releases.

## Store Configuration

The `store/marine.yaml` defines:
- Which packages appear in the Marine store (filter rules)
- Custom section labels and icons
- Store branding

## Testing

### OIDC Flow Testing

Test the complete OIDC authentication flow between Signal K and Authelia:

```bash
# Run the OIDC flow test
./tools/test-oidc-flow.sh -d myhostname.local -p "PASSWORD" -v

# Options:
#   -u, --username USER     Authelia username (default: admin)
#   -p, --password PASS     Authelia password (required)
#   -d, --domain DOMAIN     Base domain (required, e.g., myhostname.local)
#   -v, --verbose           Show verbose output
```

The test script performs a complete OIDC flow:
1. Initiates OIDC login from Signal K
2. Follows redirect to Authelia
3. Authenticates with Authelia
4. Gets authorization code
5. Completes OIDC callback
6. Verifies login status and user permissions

**Finding the Authelia admin password:**
- Check `/etc/halos-homarr-branding/branding.toml` on the device (under `[credentials]` section)
- The password is configured in the HaLOS branding package and synced to Authelia by homarr-container-adapter

### Test Output

Test results are saved to `/tmp/oidc_test_<timestamp>/`:
- `step*_headers.txt` - HTTP headers from each step
- `step*_body.html` - Response bodies
- `step6_login_status.json` - Final login status
- `step7_jwt_decoded.json` - Decoded JWT token

### Comprehensive OIDC Test Suite

Run all OIDC tests including auto-login, permissions, and SSO:

```bash
./tools/test-oidc-all.sh -d myhostname.local -p "PASSWORD" -v
```

This tests:
1. **Auto-login configuration** - Verifies OIDC and auto-login are enabled
2. **OIDC login redirect** - Verifies redirect to Authelia works
3. **Full login flow** - Complete authentication and callback
4. **Admin permissions** - Verifies admin group mapping works
5. **SSO session sharing** - Verifies existing Authelia sessions are reused

### SSO Flow Testing

Test single sign-on session sharing between Authelia and Signal K:

```bash
./tools/test-sso-flow.sh -d myhostname.local -p "PASSWORD" -v
```

This specifically tests that a user who is already authenticated with Authelia (e.g., from Homarr) can access Signal K without re-authenticating.

### Authentication Negative Tests

For testing that invalid authentication attempts are properly rejected (malformed tokens, expired tokens, OIDC callback validation, etc.), use the generic test script in the signalk-server repository:

```bash
# From the signalk-server directory
./tools/test-auth-negative.sh -u https://signalk.myhostname.local -k -v

# See signalk-server/tools/test-auth-negative.sh --help for options
```

## Related

- **Parent**: [../AGENTS.md](../AGENTS.md) - Workspace documentation
- **Tooling**: [container-packaging-tools](https://github.com/hatlabs/container-packaging-tools)
- **UI**: [cockpit-apt](https://github.com/hatlabs/cockpit-apt)
