name: Main Branch CI/CD

on:
  push:
    branches: [main]

permissions:
  contents: write

env:
  APT_DISTRO: ${{ vars.APT_DISTRO || 'trixie' }}
  APT_COMPONENT: ${{ vars.APT_COMPONENT || 'main' }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tests
        uses: ./.github/actions/run-tests

  build-and-release:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from VERSION file
        id: version
        run: |
          UPSTREAM_VERSION=$(cat VERSION)
          echo "upstream=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "Upstream version: $UPSTREAM_VERSION"

      - name: Calculate revision number
        id: revision
        run: |
          REVISION=$(.github/scripts/calculate-revision.sh "${{ steps.version.outputs.upstream }}")
          echo "revision=$REVISION" >> $GITHUB_OUTPUT
          echo "Revision number: $REVISION"

      - name: Generate store/debian/changelog
        run: |
          .github/scripts/generate-changelog.sh \
            --upstream "${{ steps.version.outputs.upstream }}" \
            --revision "${{ steps.revision.outputs.revision }}"

      - name: Set version variables
        id: versions
        run: |
          UPSTREAM="${{ steps.version.outputs.upstream }}"
          REVISION="${{ steps.revision.outputs.revision }}"
          DEBIAN_VERSION="${UPSTREAM}-${REVISION}"
          PRERELEASE_TAG="v${UPSTREAM}+${REVISION}_pre"
          STABLE_TAG="v${UPSTREAM}+${REVISION}"

          echo "debian_version=$DEBIAN_VERSION" >> $GITHUB_OUTPUT
          echo "prerelease_tag=$PRERELEASE_TAG" >> $GITHUB_OUTPUT
          echo "stable_tag=$STABLE_TAG" >> $GITHUB_OUTPUT

          echo "Debian version: $DEBIAN_VERSION"
          echo "Pre-release tag: $PRERELEASE_TAG"
          echo "Stable tag: $STABLE_TAG"

      - name: Check if pre-release exists
        id: check
        run: |
          TAG="${{ steps.versions.outputs.prerelease_tag }}"
          if gh release view "$TAG" &>/dev/null; then
            echo "action=skip" >> $GITHUB_OUTPUT
            echo "Pre-release $TAG already exists, skipping"
          else
            echo "action=create" >> $GITHUB_OUTPUT
            echo "Pre-release $TAG does not exist, will create"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build .deb package
        if: steps.check.outputs.action == 'create'
        uses: ./.github/actions/build-deb

      - name: Rename packages with distro+component suffix
        if: steps.check.outputs.action == 'create'
        run: |
          # Rename all .deb packages to include distro+component suffix
          for deb in build/*.deb; do
            if [ -f "$deb" ]; then
              # Extract base name and version
              basename=$(basename "$deb" .deb)
              # Append suffix before .deb
              newname="build/${basename}+${APT_DISTRO}+${APT_COMPONENT}.deb"
              echo "üì¶ Renaming: $(basename $deb) ‚Üí $(basename $newname)"
              mv "$deb" "$newname"
            fi
          done

          # Move renamed packages to root for release
          mv build/*.deb ./
          echo "‚úÖ All packages renamed successfully"
          ls -lh *.deb

      - name: Generate pre-release notes
        if: steps.check.outputs.action == 'create'
        id: notes
        run: |
          .github/scripts/generate-release-notes.sh \
            "${{ steps.versions.outputs.debian_version }}" \
            "${{ steps.versions.outputs.prerelease_tag }}" \
            prerelease
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create pre-release
        if: steps.check.outputs.action == 'create'
        run: |
          PRERELEASE_TAG="${{ steps.versions.outputs.prerelease_tag }}"
          if ! ls *.deb 1> /dev/null 2>&1; then
            echo "‚ùå Error: No .deb files found"
            exit 1
          fi
          echo "üì¶ Creating pre-release $PRERELEASE_TAG"
          gh release create "$PRERELEASE_TAG" \
            --prerelease \
            --title "$PRERELEASE_TAG (Pre-release)" \
            --notes-file release_notes.md \
            *.deb
          echo "‚úÖ Pre-release created successfully"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create draft stable release
        if: steps.check.outputs.action == 'create'
        run: |
          STABLE_TAG="${{ steps.versions.outputs.stable_tag }}"
          DEBIAN_VERSION="${{ steps.versions.outputs.debian_version }}"

          # Check if stable release already exists
          if gh release view "$STABLE_TAG" &>/dev/null; then
            echo "Release $STABLE_TAG already exists, skipping creation"
          else
            # Generate release notes for draft
            .github/scripts/generate-release-notes.sh "$DEBIAN_VERSION" "$STABLE_TAG" draft

            echo "üìã Creating draft release $STABLE_TAG with .deb packages"
            gh release create "$STABLE_TAG" \
              --draft \
              --title "$STABLE_TAG" \
              --notes-file release_notes.md \
              *.deb
            echo "‚úÖ Draft release created successfully with .deb attached"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Dispatch to APT repository
        if: steps.check.outputs.action == 'create'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_PAT }}
          repository: hatlabs/apt.hatlabs.fi
          event-type: package-updated
          client-payload: |
            {
              "repository": "${{ github.repository }}",
              "distro": "${{ env.APT_DISTRO }}",
              "channel": "unstable",
              "component": "${{ env.APT_COMPONENT }}"
            }

      - name: Report success
        if: steps.check.outputs.action == 'create'
        run: |
          DEBIAN_VERSION="${{ steps.versions.outputs.debian_version }}"
          PRERELEASE_TAG="${{ steps.versions.outputs.prerelease_tag }}"
          STABLE_TAG="${{ steps.versions.outputs.stable_tag }}"
          echo "=== Main Branch CI/CD Complete ==="
          echo "Debian package version: ${DEBIAN_VERSION}"
          echo "Pre-release tag: ${PRERELEASE_TAG}"
          echo "Stable tag (draft): ${STABLE_TAG}"
          echo "Pre-release URL: https://github.com/${{ github.repository }}/releases/tag/${PRERELEASE_TAG}"
          echo "Draft URL: https://github.com/${{ github.repository }}/releases/tag/${STABLE_TAG}"
          echo ""
          echo "‚úÖ Pre-release created with .deb packages"
          echo "‚úÖ Draft release created with .deb attached"
          echo "‚úÖ Dispatched to apt.hatlabs.fi unstable channel"
          echo ""
          echo "üìù To publish stable release:"
          echo "   1. Test the unstable package"
          echo "   2. Publish the draft release in GitHub UI"
          echo "   3. release.yml will dispatch to stable channel"
