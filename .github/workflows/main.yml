name: Main Branch CI/CD

on:
  push:
    branches: [main]

permissions:
  contents: write

env:
  APT_DISTRO: ${{ vars.APT_DISTRO || 'trixie' }}
  APT_COMPONENT: ${{ vars.APT_COMPONENT || 'main' }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tests
        uses: ./.github/actions/run-tests

  build-and-release:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from debian/changelog
        id: version
        run: .github/scripts/read-version.sh

      - name: Check if published release exists
        id: check
        run: .github/scripts/check-release-exists.sh "${{ steps.version.outputs.version }}" prerelease
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build .deb package
        if: steps.check.outputs.action == 'create'
        uses: ./.github/actions/build-deb

      - name: Rename packages with distro+component suffix
        if: steps.check.outputs.action == 'create'
        run: |
          # Rename all .deb packages to include distro+component suffix
          for deb in build/*.deb; do
            if [ -f "$deb" ]; then
              # Extract base name and version
              basename=$(basename "$deb" .deb)
              # Append suffix before .deb
              newname="build/${basename}+${APT_DISTRO}+${APT_COMPONENT}.deb"
              echo "ðŸ“¦ Renaming: $(basename $deb) â†’ $(basename $newname)"
              mv "$deb" "$newname"
            fi
          done

          # Move renamed packages to root for release
          mv build/*.deb ./
          echo "âœ… All packages renamed successfully"
          ls -lh *.deb

      - name: Generate release notes
        if: steps.check.outputs.action == 'create'
        id: notes
        run: .github/scripts/generate-release-notes.sh "${{ steps.version.outputs.version }}" "${{ steps.version.outputs.tag_version }}" prerelease
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Delete existing pre-release
        if: steps.check.outputs.action == 'create'
        run: |
          TAG_VERSION="${{ steps.version.outputs.tag_version }}"
          if gh release view "v${TAG_VERSION}" &>/dev/null; then
            IS_PRERELEASE=$(gh release view "v${TAG_VERSION}" --json isPrerelease --jq '.isPrerelease')
            if [ "$IS_PRERELEASE" = "true" ]; then
              echo "ðŸ—‘ï¸  Deleting existing pre-release v${TAG_VERSION}"
              gh release delete "v${TAG_VERSION}" --yes --cleanup-tag
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create pre-release
        if: steps.check.outputs.action == 'create'
        run: |
          TAG_VERSION="${{ steps.version.outputs.tag_version }}"
          if ! ls *.deb 1> /dev/null 2>&1; then
            echo "âŒ Error: No .deb files found"
            exit 1
          fi
          echo "ðŸ“¦ Creating pre-release v${TAG_VERSION}"
          gh release create "v${TAG_VERSION}" \
            --prerelease \
            --title "v${TAG_VERSION} (Pre-release)" \
            --notes-file release_notes.md \
            *.deb
          echo "âœ… Pre-release created successfully"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create draft release
        if: steps.check.outputs.action == 'create'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_VERSION="${{ steps.version.outputs.tag_version }}"

          # Check if draft release already exists
          if gh release view "v${VERSION}" &>/dev/null; then
            IS_DRAFT=$(gh release view "v${VERSION}" --json isDraft --jq '.isDraft')
            IS_PRERELEASE=$(gh release view "v${VERSION}" --json isPrerelease --jq '.isPrerelease')

            if [ "$IS_DRAFT" = "true" ] && [ "$IS_PRERELEASE" = "false" ]; then
              echo "Draft release v${VERSION} already exists, skipping creation"
            fi
          else
            # Generate release notes for draft
            .github/scripts/generate-release-notes.sh "${VERSION}" "${VERSION}" draft

            echo "ðŸ“‹ Creating draft release v${VERSION}"
            gh release create "v${VERSION}" \
              --draft \
              --title "v${VERSION}" \
              --notes-file release_notes.md
            echo "âœ… Draft release created successfully"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Dispatch to APT repository
        if: steps.check.outputs.action == 'create'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_PAT }}
          repository: hatlabs/apt.hatlabs.fi
          event-type: package-updated
          client-payload: |
            {
              "repository": "${{ github.repository }}",
              "distro": "${{ env.APT_DISTRO }}",
              "channel": "unstable",
              "component": "${{ env.APT_COMPONENT }}"
            }

      - name: Report success
        if: steps.check.outputs.action == 'create'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_VERSION="${{ steps.version.outputs.tag_version }}"
          echo "=== Main Branch CI/CD Complete ==="
          echo "Package version: ${VERSION}"
          echo "Release tag: v${TAG_VERSION}"
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/v${TAG_VERSION}"
          echo ""
          echo "âœ… Pre-release created"
          echo "âœ… Draft release created"
          echo "âœ… Dispatched to apt.hatlabs.fi unstable channel"
