name: Release Published

on:
  release:
    types: [published]

permissions:
  contents: read

env:
  APT_DISTRO: ${{ vars.APT_DISTRO || 'any' }}
  APT_COMPONENT: ${{ vars.APT_COMPONENT || 'main' }}

jobs:
  dispatch-to-apt:
    runs-on: ubuntu-latest
    # Only handle stable releases - pre-releases are handled by main.yml
    if: ${{ github.event.release.prerelease == false }}
    steps:
      - name: Extract version info from tag
        id: version
        run: |
          STABLE_TAG="${{ github.event.release.tag_name }}"
          echo "stable_tag=$STABLE_TAG" >> $GITHUB_OUTPUT

          # Extract upstream and revision from stable tag (v0.1.0+2 -> 0.1.0 and 2)
          if [[ $STABLE_TAG =~ ^v([0-9]+\.[0-9]+\.[0-9]+)\+([0-9]+)$ ]]; then
            UPSTREAM="${BASH_REMATCH[1]}"
            REVISION="${BASH_REMATCH[2]}"

            echo "upstream=$UPSTREAM" >> $GITHUB_OUTPUT
            echo "revision=$REVISION" >> $GITHUB_OUTPUT

            echo "Stable tag: $STABLE_TAG"
            echo "Upstream: $UPSTREAM"
            echo "Revision: $REVISION"
          else
            echo "Error: Tag format invalid. Expected: v{version}+{N}"
            echo "Got: $STABLE_TAG"
            exit 1
          fi

      - name: Verify release has assets
        run: |
          STABLE_TAG="${{ steps.version.outputs.stable_tag }}"
          ASSET_COUNT=$(gh release view "$STABLE_TAG" --repo ${{ github.repository }} --json assets --jq '.assets | length')

          if [ "$ASSET_COUNT" -eq 0 ]; then
            echo "❌ Error: Release has no assets attached"
            echo "The .deb packages should have been attached when the draft was created"
            exit 1
          fi

          echo "✅ Release has $ASSET_COUNT asset(s)"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Trigger APT repository
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_PAT }}
          repository: hatlabs/apt.hatlabs.fi
          event-type: package-updated
          client-payload: |
            {
              "repository": "${{ github.repository }}",
              "distro": "${{ env.APT_DISTRO }}",
              "channel": "stable",
              "component": "${{ env.APT_COMPONENT }}"
            }

      - name: Report success
        run: |
          STABLE_TAG="${{ steps.version.outputs.stable_tag }}"
          UPSTREAM="${{ steps.version.outputs.upstream }}"
          REVISION="${{ steps.version.outputs.revision }}"

          echo "=== Stable Release Published ==="
          echo "Stable tag: $STABLE_TAG"
          echo "Debian version: ${UPSTREAM}-${REVISION}"
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/$STABLE_TAG"
          echo ""
          echo "✅ Dispatched to apt.hatlabs.fi stable channel"
