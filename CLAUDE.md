⚠️ **THESE RULES ONLY APPLY TO FILES IN /halos-marine-containers/** ⚠️

# HaLOS Marine Containers

Marine container store definition and curated marine application definitions.

**Local Instructions**: For environment-specific instructions and configurations, see @CLAUDE.local.md (not committed to version control).

## Git Workflow Policy

**Branch Workflow:** Never push to main directly - always use feature branches and PRs.

**Link issues and PRs:** Always link related GitHub issues in PR descriptions with `Closes #<issue-number>`.

## Version Management

**Version System:** Unified HaLOS versioning with auto-incrementing revisions.

### Version Components

**VERSION file** (canonical source):
- Contains upstream version only (e.g., `0.1.0`)
- No 'v' prefix, no revision
- Applies to marine-container-store package

**Git tags** (auto-generated by CI):
- Pre-release: `v{upstream}+{N}_pre` (unstable channel, DEP-14 compliant)
- Stable: `v{upstream}+{N}` (stable channel)
- N = auto-calculated from existing git tags
- Note: Underscore used instead of tilde for git tag validity

**Debian package version**:
- Format: `{upstream}-{N}`
- Generated dynamically by CI in `store/debian/changelog`

**Example version progression**:
```
Git tags:    v0.1.0+1_pre < v0.1.0+1 < v0.1.0+2_pre < v0.1.0+2 < v0.2.0+1_pre < v0.2.0+1
Debian pkgs: 0.1.0-1      = 0.1.0-1 < 0.1.0-2      = 0.1.0-2 < 0.2.0-1      = 0.2.0-1
```
Note: Same .deb binaries (0.1.0-N) are used for both pre-release and stable tags

### Version Bump Workflow

**To bump the upstream version:**

```bash
# Edit VERSION file manually
echo "0.2.0" > VERSION

# Commit the change
git add VERSION
git commit -m "chore: bump version to 0.2.0"
git push origin main
```

**What happens automatically:**
1. CI reads VERSION file
2. CI calculates next revision number (N)
3. CI generates `store/debian/changelog` with version `{upstream}-{N}`
4. CI builds .deb packages (store + apps)
5. CI creates pre-release tag `v{upstream}+{N}_pre` with .debs
6. CI creates draft release tag `v{upstream}+{N}` with .debs
7. CI dispatches to apt.hatlabs.fi unstable channel

**To publish a stable release:**
1. Test the unstable packages
2. Publish the draft release in GitHub UI
3. `release.yml` dispatches to apt.hatlabs.fi stable channel

### Key Benefits

✅ Auto-incrementing revisions (no manual coordination)
✅ Same .deb binaries for unstable and stable
✅ Monotonic version ordering (each build > previous)
✅ Works with semver, date-based, or arbitrary versions
✅ Git-compliant tag names (DEP-14 standard)

### Rebuild Scenario

If you need to rebuild without changing the upstream version:
1. Just push to main
2. CI auto-increments the revision number
3. New build gets version `{upstream}-{N+1}`

### Version Scripts

**`.github/scripts/calculate-revision.sh`**: Query git tags to find next N
**`.github/scripts/generate-changelog.sh`**: Generate store/debian/changelog dynamically
**`.github/scripts/test-version-handling.sh`**: Test version format and DEP-14 compliance

### DEP-14 Compliance

Git tags follow [DEP-14](https://dep-team.pages.debian.net/deps/dep14/) version mangling:
- Underscore (`_`) in git tags represents tilde (`~`) in Debian versions
- Since we use the same .deb for both channels, no unmangling is needed
- Pre-release tags use `_pre` suffix (git-valid) instead of `~pre` (git-invalid)

## What This Repository Contains

**Two things in one repository**:
1. **Marine Container Store** (`store/`) - Store definition package
2. **Marine Apps** (`apps/`) - Curated marine application definitions

**Rationale**: Store and apps are tightly coupled. The store defines which apps belong in the marine category, and those apps live right here. Single source of truth, unified CI/CD.

## Repository Structure

```
halos-marine-containers/
├── store/
│   ├── marine.yaml          # Store configuration
│   ├── icon.svg             # Branding (256x256)
│   ├── banner.png           # Branding (1200x300)
│   └── debian/              # Debian packaging for store package
│       ├── control
│       ├── rules
│       ├── install
│       └── ...
├── apps/
│   ├── signalk-server/
│   │   ├── docker-compose.yml
│   │   ├── config.yml
│   │   ├── metadata.json
│   │   └── icon.png
│   ├── opencpn/
│   └── ...
├── tools/
│   └── build-all.sh         # Build all packages
├── .github/workflows/
│   └── build.yml            # CI/CD
├── docs/
│   └── DESIGN.md            # Detailed design docs
└── README.md
```

## Adding a New Marine App

See [docs/DESIGN.md](docs/DESIGN.md) for complete instructions.

**Quick overview**:
1. Create `apps/<app-name>/` directory
2. Add `docker-compose.yml`, `config.yml`, `metadata.json`, `icon.png`
3. Test locally with `generate-container-packages`
4. Create PR - CI will build and validate

## Building

**Requirements**: `container-packaging-tools` installed

```bash
# Build all packages (store + apps)
./tools/build-all.sh

# Output: build/*.deb
```

**CI/CD**: GitHub Actions builds on push and creates releases.

## Store Configuration

The `store/marine.yaml` defines:
- Which packages appear in the Marine store (filter rules)
- Custom section labels and icons
- Store branding

## Related

- **Parent**: [../CLAUDE.md](../CLAUDE.md) - Workspace documentation
- **Tooling**: [container-packaging-tools](https://github.com/hatlabs/container-packaging-tools)
- **UI**: [cockpit-apt](https://github.com/hatlabs/cockpit-apt)
