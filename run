#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands for halos-marine-containers development.
#
# See https://death.andgravity.com/run-sh
# for an explanation of how it works and why it's useful.

# First, set up the environment.
# (Check the notes at the end when changing this.)

set -o nounset
set -o pipefail
set -o errexit

# Enable this to echo commands as they are executed.
#set -o xtrace

# Change the current directory to the project root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

# Store the absolute path to this script (useful for recursion).
readonly SCRIPT="$PROJECT_ROOT/$(basename "$0")"

################################################################################
# Test Commands

function test {
  #@ Run test suite in Docker container
  #@ Category: Testing
  echo "ðŸ§ª Running tests..."
  docker run --rm -v "$(pwd):/workspace" -w /workspace python:3.11-slim \
    bash -c "pip install -q pytest pyyaml && python -m pytest tests/ -v"
}

function test:watch {
  #@ Run tests in watch mode (requires pytest-watch locally)
  #@ Category: Testing
  echo "ðŸ‘€ Watching tests..."
  if ! command -v ptw &> /dev/null; then
    echo "âŒ pytest-watch not found. Install with: pip install pytest-watch"
    return 1
  fi
  ptw tests/
}

################################################################################
# Cleanup Commands

function clean {
  #@ Clean build artifacts and cache
  #@ Category: Utility
  echo "ðŸ§¹ Cleaning..."
  rm -rf build/ dist/ *.egg-info
  rm -rf .pytest_cache
  find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
  find . -type f -name "*.pyc" -delete
  echo "âœ… Cleaned"
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Core
  echo "HaLOS Marine Containers - Development Commands"
  echo "=============================================="
  echo ""
  echo "Available commands:"
  echo ""

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-30s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
}

################################################################################
# Commands end.

# Dispatch to command. A simpler version would be just "$@" (with the quotes!).

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"

# Some dev notes for this script.
#
# The commands *require*:
#
# * The current working directory is the project root.
# * The shell options and globals are set as they are.
#
# Inspired by the following:
#  - https://death.andgravity.com/run-sh
#  - http://www.oilshell.org/blog/2020/02/good-parts-sketch.html
#  - https://www.youtube.com/watch?v=SdmYd5hJISM&t=7s
